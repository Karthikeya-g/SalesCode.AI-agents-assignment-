# Intelligent Interruption Handling for LiveKit Agents

This repository implements a context-aware **Interruption Logic Layer** for LiveKit Voice Agents. It solves the common "barge-in" problem where agents prematurely stop speaking when detecting passive user feedback (backchanneling) like *"Yeah"*, *"Uh-huh"*, or *"Okay"*.

## ğŸ¯ The Problem
Standard Voice Activity Detection (VAD) is binary: it detects sound and triggers an interruption. This creates a robotic experience where the user cannot actively listen or acknowledge statements without cutting off the agent.

## ğŸ’¡ The Solution
We implemented a **Logic Middleware** pattern that intercepts the Speech-to-Text (STT) stream before it triggers an interruption.

### Key Architectural Changes:
1.  **Disabled Auto-Turn Detection:** We set `turn_detection=None`. This removes the "hard wire" between the VAD and the agent's interruption trigger.
2.  **Stream-Based Filtering:** We listen to `user_transcription_received` to analyze user intent in real-time (stream latency ~300ms).
3.  **Semantic Analysis:** The agent distinguishes between **Backchanneling** (Ignore) and **Commands** (Interrupt) based on a configurable ignore list.
4.  **State Awareness:** The agent behaves differently depending on whether it is currently **Speaking** or **Silent**.

### The Logic Matrix
The solution satisfies the following logic requirements:

| User Input | Agent State | Action | Reasoning |
| :--- | :--- | :--- | :--- |
| **"Yeah" / "Uh-huh"** | ğŸ—£ï¸ Speaking | **IGNORE** | Passive listening; Agent continues seamlessly. |
| **"Wait" / "Stop"** | ğŸ—£ï¸ Speaking | **INTERRUPT** | Semantic command; Agent yields the floor. |
| **"Yeah"** | ğŸ˜¶ Silent | **RESPOND** | Valid conversational turn; Agent replies. |

## ğŸ› ï¸ Implementation Details

### 1. Configurable Ignore List
A centralized set of words handles variations in STT punctuation (e.g., "uh-huh" vs "uh huh").
```python
IGNORE_WORDS = {
    "yeah", "yep", "yes", "ok", "okay", "alright", 
    "hmm", "mhm", "aha", "uh-huh", "uhhuh", "mm-hm", "mmhm",
    "right", "sure", "correct", "yea", "oka"
}

@session.on("user_transcription_received")
def on_transcription(msg):
    text = clean_text(msg.content)
    
    # Check if the input is ONLY backchannel words
    is_backchannel = is_subset_of_ignore_list(text)

    if session.response_agent.is_speaking:
        if is_backchannel:
            # Logic: User is listening. Do not stop.
            print(f"ğŸŸ¢ IGNORE: Backchannel detected '{text}'")
        else:
            # Logic: User wants to interrupt.
            print(f"ğŸ”´ INTERRUPT: Valid command '{text}'")
            session.response_agent.interrupt()

@session.on("user_speech_committed")
def on_user_speech_committed(msg):
    if not session.response_agent.is_speaking:
        session.generate_reply()
